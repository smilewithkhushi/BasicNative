{"version":3,"sources":["../../../../src/utils/telemetry/flushDetached.ts"],"sourcesContent":["import fs from 'fs';\n\nimport type { DetachedTelemetry } from './DetachedClient';\nimport { RudderClient } from './RudderClient';\nimport { getUserAsync } from '../../api/user/user';\n\nconst telemetryFile = process.argv[2];\n\nflush()\n  .catch(() => fs.promises.unlink(telemetryFile))\n  .finally(() => process.exit(0));\n\nasync function flush() {\n  if (!telemetryFile) return;\n\n  let json: string;\n  let data: DetachedTelemetry;\n\n  try {\n    json = await fs.promises.readFile(telemetryFile, 'utf8');\n    data = JSON.parse(json) as DetachedTelemetry;\n  } catch (error: any) {\n    if (error.code === 'ENOENT') return;\n    throw error;\n  }\n\n  if (!data.records.length) {\n    return;\n  }\n\n  const client = new RudderClient(undefined, 'detached');\n  await client.identify(data.actor || (await getUserAsync()));\n\n  for (const record of data.records) {\n    await client.record(record);\n  }\n\n  await client.flush();\n  await fs.promises.unlink(telemetryFile);\n}\n"],"names":["telemetryFile","process","argv","flush","catch","fs","promises","unlink","finally","exit","json","data","readFile","JSON","parse","error","code","records","length","client","RudderClient","undefined","identify","actor","getUserAsync","record"],"mappings":"AAAA;;;;;8DAAe,IAAI;;;;;;8BAGU,gBAAgB;sBAChB,qBAAqB;;;;;;AAElD,MAAMA,aAAa,GAAGC,OAAO,CAACC,IAAI,CAAC,CAAC,CAAC,AAAC;AAEtCC,KAAK,EAAE,CACJC,KAAK,CAAC,IAAMC,GAAE,EAAA,QAAA,CAACC,QAAQ,CAACC,MAAM,CAACP,aAAa,CAAC,CAAC,CAC9CQ,OAAO,CAAC,IAAMP,OAAO,CAACQ,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;AAElC,eAAeN,KAAK,GAAG;IACrB,IAAI,CAACH,aAAa,EAAE,OAAO;IAE3B,IAAIU,IAAI,AAAQ,AAAC;IACjB,IAAIC,IAAI,AAAmB,AAAC;IAE5B,IAAI;QACFD,IAAI,GAAG,MAAML,GAAE,EAAA,QAAA,CAACC,QAAQ,CAACM,QAAQ,CAACZ,aAAa,EAAE,MAAM,CAAC,CAAC;QACzDW,IAAI,GAAGE,IAAI,CAACC,KAAK,CAACJ,IAAI,CAAC,AAAqB,CAAC;IAC/C,EAAE,OAAOK,KAAK,EAAO;QACnB,IAAIA,KAAK,CAACC,IAAI,KAAK,QAAQ,EAAE,OAAO;QACpC,MAAMD,KAAK,CAAC;IACd,CAAC;IAED,IAAI,CAACJ,IAAI,CAACM,OAAO,CAACC,MAAM,EAAE;QACxB,OAAO;IACT,CAAC;IAED,MAAMC,MAAM,GAAG,IAAIC,aAAY,aAAA,CAACC,SAAS,EAAE,UAAU,CAAC,AAAC;IACvD,MAAMF,MAAM,CAACG,QAAQ,CAACX,IAAI,CAACY,KAAK,IAAK,MAAMC,IAAAA,KAAY,aAAA,GAAE,AAAC,CAAC,CAAC;IAE5D,KAAK,MAAMC,MAAM,IAAId,IAAI,CAACM,OAAO,CAAE;QACjC,MAAME,MAAM,CAACM,MAAM,CAACA,MAAM,CAAC,CAAC;IAC9B,CAAC;IAED,MAAMN,MAAM,CAAChB,KAAK,EAAE,CAAC;IACrB,MAAME,GAAE,EAAA,QAAA,CAACC,QAAQ,CAACC,MAAM,CAACP,aAAa,CAAC,CAAC;AAC1C,CAAC"}