{"version":3,"sources":["../../../../../../src/run/ios/appleDevice/client/InstallationProxyClient.ts"],"sourcesContent":["/**\n * Copyright (c) 2021 Expo, Inc.\n * Copyright (c) 2018 Drifty Co.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport Debug from 'debug';\nimport { Socket } from 'net';\n\nimport { ResponseError, ServiceClient } from './ServiceClient';\nimport { LockdownProtocolClient } from '../protocol/LockdownProtocol';\nimport type { LockdownCommand, LockdownResponse } from '../protocol/LockdownProtocol';\n\nconst debug = Debug('expo:apple-device:client:installation_proxy');\n\nexport type OnInstallProgressCallback = (props: {\n  status: string;\n  isComplete: boolean;\n  // copiedFiles: number;\n  progress: number;\n}) => void;\n\ninterface IPOptions {\n  ApplicationsType?: 'Any';\n  PackageType?: 'Developer';\n  CFBundleIdentifier?: string;\n\n  ReturnAttributes?: (\n    | 'CFBundleIdentifier'\n    | 'ApplicationDSID'\n    | 'ApplicationType'\n    | 'CFBundleExecutable'\n    | 'CFBundleDisplayName'\n    | 'CFBundleIconFile'\n    | 'CFBundleName'\n    | 'CFBundleShortVersionString'\n    | 'CFBundleSupportedPlatforms'\n    | 'CFBundleURLTypes'\n    | 'CodeInfoIdentifier'\n    | 'Container'\n    | 'Entitlements'\n    | 'HasSettingsBundle'\n    | 'IsUpgradeable'\n    | 'MinimumOSVersion'\n    | 'Path'\n    | 'SignerIdentity'\n    | 'UIDeviceFamily'\n    | 'UIFileSharingEnabled'\n    | 'UIStatusBarHidden'\n    | 'UISupportedInterfaceOrientations'\n  )[];\n  BundleIDs?: string[];\n  [key: string]: undefined | string | string[];\n}\n\ninterface IPInstallPercentCompleteResponseItem extends LockdownResponse {\n  PercentComplete: number;\n}\n\ninterface IPInstallCFBundleIdentifierResponseItem {\n  CFBundleIdentifier: string;\n}\n\ninterface IPInstallCompleteResponseItem extends LockdownResponse {\n  Status: 'Complete';\n}\n/*\n *  [{ \"PercentComplete\": 5, \"Status\": \"CreatingStagingDirectory\" }]\n *  ...\n *  [{ \"PercentComplete\": 90, \"Status\": \"GeneratingApplicationMap\" }]\n *  [{ \"CFBundleIdentifier\": \"my.company.app\" }]\n *  [{ \"Status\": \"Complete\" }]\n */\ntype IPInstallPercentCompleteResponse = IPInstallPercentCompleteResponseItem[];\ntype IPInstallCFBundleIdentifierResponse = IPInstallCFBundleIdentifierResponseItem[];\ntype IPInstallCompleteResponse = IPInstallCompleteResponseItem[];\n\ninterface IPMessage extends LockdownCommand {\n  Command: string;\n  ClientOptions: IPOptions;\n}\n\ninterface IPLookupResponseItem extends LockdownResponse {\n  LookupResult: IPLookupResult;\n}\n/*\n * [{\n *    LookupResult: IPLookupResult,\n *    Status: \"Complete\"\n *  }]\n */\ntype IPLookupResponse = IPLookupResponseItem[];\n\nexport interface IPLookupResult {\n  // BundleId\n  [key: string]: {\n    Container: string;\n    CFBundleIdentifier: string;\n    CFBundleExecutable: string;\n    Path: string;\n  };\n}\n\nfunction isIPLookupResponse(resp: any): resp is IPLookupResponse {\n  return resp.length && resp[0].LookupResult !== undefined;\n}\n\nfunction isIPInstallPercentCompleteResponse(resp: any): resp is IPInstallPercentCompleteResponse {\n  return resp.length && resp[0].PercentComplete !== undefined;\n}\n\nfunction isIPInstallCFBundleIdentifierResponse(\n  resp: any\n): resp is IPInstallCFBundleIdentifierResponse {\n  return resp.length && resp[0].CFBundleIdentifier !== undefined;\n}\n\nfunction isIPInstallCompleteResponse(resp: any): resp is IPInstallCompleteResponse {\n  return resp.length && resp[0].Status === 'Complete';\n}\n\nexport class InstallationProxyClient extends ServiceClient<LockdownProtocolClient<IPMessage>> {\n  constructor(public socket: Socket) {\n    super(socket, new LockdownProtocolClient(socket));\n  }\n\n  async lookupApp(\n    bundleIds: string[],\n    options: IPOptions = {\n      ReturnAttributes: ['Path', 'Container', 'CFBundleExecutable', 'CFBundleIdentifier'],\n      ApplicationsType: 'Any',\n    }\n  ) {\n    debug(`lookupApp, options: ${JSON.stringify(options)}`);\n\n    let resp = await this.protocolClient.sendMessage({\n      Command: 'Lookup',\n      ClientOptions: {\n        BundleIDs: bundleIds,\n        ...options,\n      },\n    });\n    if (resp && !Array.isArray(resp)) resp = [resp];\n    if (isIPLookupResponse(resp)) {\n      return resp[0].LookupResult;\n    } else {\n      throw new ResponseError(`There was an error looking up app`, resp);\n    }\n  }\n\n  async installApp(\n    packagePath: string,\n    bundleId: string,\n    options: IPOptions = {\n      ApplicationsType: 'Any',\n      PackageType: 'Developer',\n    },\n    onProgress: OnInstallProgressCallback\n  ) {\n    debug(`installApp, packagePath: ${packagePath}, bundleId: ${bundleId}`);\n\n    return this.protocolClient.sendMessage(\n      {\n        Command: 'Install',\n        PackagePath: packagePath,\n        ClientOptions: {\n          CFBundleIdentifier: bundleId,\n          ...options,\n        },\n      },\n      (resp, resolve, reject) => {\n        if (resp && !Array.isArray(resp)) resp = [resp];\n\n        if (isIPInstallCompleteResponse(resp)) {\n          onProgress({\n            isComplete: true,\n            progress: 100,\n            status: resp[0].Status,\n          });\n          resolve();\n        } else if (isIPInstallPercentCompleteResponse(resp)) {\n          onProgress({\n            isComplete: false,\n            progress: resp[0].PercentComplete,\n            status: resp[0].Status,\n          });\n          debug(`Installation status: ${resp[0].Status}, %${resp[0].PercentComplete}`);\n        } else if (isIPInstallCFBundleIdentifierResponse(resp)) {\n          debug(`Installed app: ${resp[0].CFBundleIdentifier}`);\n        } else {\n          reject(\n            new ResponseError(\n              'There was an error installing app: ' + require('util').inspect(resp),\n              resp\n            )\n          );\n        }\n      }\n    );\n  }\n}\n"],"names":["InstallationProxyClient","debug","Debug","isIPLookupResponse","resp","length","LookupResult","undefined","isIPInstallPercentCompleteResponse","PercentComplete","isIPInstallCFBundleIdentifierResponse","CFBundleIdentifier","isIPInstallCompleteResponse","Status","ServiceClient","constructor","socket","LockdownProtocolClient","lookupApp","bundleIds","options","ReturnAttributes","ApplicationsType","JSON","stringify","protocolClient","sendMessage","Command","ClientOptions","BundleIDs","Array","isArray","ResponseError","installApp","packagePath","bundleId","PackageType","onProgress","PackagePath","resolve","reject","isComplete","progress","status","require","inspect"],"mappings":"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"}