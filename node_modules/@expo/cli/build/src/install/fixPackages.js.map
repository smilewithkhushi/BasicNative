{"version":3,"sources":["../../../src/install/fixPackages.ts"],"sourcesContent":["import * as PackageManager from '@expo/package-manager';\nimport chalk from 'chalk';\n\nimport { applyPluginsAsync } from './applyPlugins';\nimport { installExpoPackageAsync } from './installExpoPackage';\nimport * as Log from '../log';\nimport { getOperationLog } from '../start/doctor/dependencies/getVersionedPackages';\nimport { getVersionedDependenciesAsync } from '../start/doctor/dependencies/validateDependenciesVersions';\nimport { groupBy } from '../utils/array';\n\n/**\n * Given a list of incompatible packages, installs the correct versions of the packages with the package manager used for the project.\n */\nexport async function fixPackagesAsync(\n  projectRoot: string,\n  {\n    packages,\n    packageManager,\n    sdkVersion,\n    packageManagerArguments,\n  }: {\n    packages: Awaited<ReturnType<typeof getVersionedDependenciesAsync>>;\n    /** Package manager to use when installing the versioned packages. */\n    packageManager: PackageManager.NodePackageManager;\n    /**\n     * SDK to version `packages` for.\n     * @example '44.0.0'\n     */\n    sdkVersion: string;\n    /**\n     * Extra parameters to pass to the `packageManager` when installing versioned packages.\n     * @example ['--no-save']\n     */\n    packageManagerArguments: string[];\n  }\n): Promise<void> {\n  if (!packages.length) {\n    return;\n  }\n\n  const { dependencies = [], devDependencies = [] } = groupBy(packages, (dep) => dep.packageType);\n  const versioningMessages = getOperationLog({\n    othersCount: 0, // All fixable packages are versioned\n    nativeModulesCount: packages.length,\n    sdkVersion,\n  });\n\n  // display all packages to update, including expo package\n  Log.log(\n    chalk`\\u203A Installing ${\n      versioningMessages.length ? versioningMessages.join(' and ') + ' ' : ''\n    }using {bold ${packageManager.name}}`\n  );\n\n  // if updating expo package, install this first, then run expo install --fix again under new version\n  const expoDep = dependencies.find((dep) => dep.packageName === 'expo');\n  if (expoDep) {\n    await installExpoPackageAsync(projectRoot, {\n      packageManager,\n      packageManagerArguments,\n      expoPackageToInstall: `expo@${expoDep.expectedVersionOrRange}`,\n      followUpCommandArgs: ['--fix'],\n    });\n    // follow-up commands will be spawned in a detached process, so return immediately\n    return;\n  }\n\n  if (dependencies.length) {\n    const versionedPackages = dependencies.map(\n      (dep) => `${dep.packageName}@${dep.expectedVersionOrRange}`\n    );\n\n    await packageManager.addAsync([...packageManagerArguments, ...versionedPackages]);\n\n    await applyPluginsAsync(projectRoot, versionedPackages);\n  }\n\n  if (devDependencies.length) {\n    await packageManager.addDevAsync([\n      ...packageManagerArguments,\n      ...devDependencies.map((dep) => `${dep.packageName}@${dep.expectedVersionOrRange}`),\n    ]);\n  }\n}\n"],"names":["fixPackagesAsync","projectRoot","packages","packageManager","sdkVersion","packageManagerArguments","length","dependencies","devDependencies","groupBy","dep","packageType","versioningMessages","getOperationLog","othersCount","nativeModulesCount","Log","log","chalk","join","name","expoDep","find","packageName","installExpoPackageAsync","expoPackageToInstall","expectedVersionOrRange","followUpCommandArgs","versionedPackages","map","addAsync","applyPluginsAsync","addDevAsync"],"mappings":"AAAA;;;;+BAasBA,kBAAgB;;aAAhBA,gBAAgB;;;8DAZpB,OAAO;;;;;;8BAES,gBAAgB;oCACV,sBAAsB;2DACzC,QAAQ;sCACG,mDAAmD;uBAE3D,gBAAgB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAKjC,eAAeA,gBAAgB,CACpCC,WAAmB,EACnB,EACEC,QAAQ,CAAA,EACRC,cAAc,CAAA,EACdC,UAAU,CAAA,EACVC,uBAAuB,CAAA,EAexB,EACc;IACf,IAAI,CAACH,QAAQ,CAACI,MAAM,EAAE;QACpB,OAAO;IACT,CAAC;IAED,MAAM,EAAEC,YAAY,EAAG,EAAE,CAAA,EAAEC,eAAe,EAAG,EAAE,CAAA,EAAE,GAAGC,IAAAA,MAAO,QAAA,EAACP,QAAQ,EAAE,CAACQ,GAAG,GAAKA,GAAG,CAACC,WAAW,CAAC,AAAC;IAChG,MAAMC,kBAAkB,GAAGC,IAAAA,qBAAe,gBAAA,EAAC;QACzCC,WAAW,EAAE,CAAC;QACdC,kBAAkB,EAAEb,QAAQ,CAACI,MAAM;QACnCF,UAAU;KACX,CAAC,AAAC;IAEH,yDAAyD;IACzDY,IAAG,CAACC,GAAG,CACLC,IAAAA,MAAK,EAAA,QAAA,CAAA,CAAC,kBAAkB,EACtBN,kBAAkB,CAACN,MAAM,GAAGM,kBAAkB,CAACO,IAAI,CAAC,OAAO,CAAC,GAAG,GAAG,GAAG,EAAE,CACxE,YAAY,EAAEhB,cAAc,CAACiB,IAAI,CAAC,CAAC,CAAC,CACtC,CAAC;IAEF,oGAAoG;IACpG,MAAMC,OAAO,GAAGd,YAAY,CAACe,IAAI,CAAC,CAACZ,GAAG,GAAKA,GAAG,CAACa,WAAW,KAAK,MAAM,CAAC,AAAC;IACvE,IAAIF,OAAO,EAAE;QACX,MAAMG,IAAAA,mBAAuB,wBAAA,EAACvB,WAAW,EAAE;YACzCE,cAAc;YACdE,uBAAuB;YACvBoB,oBAAoB,EAAE,CAAC,KAAK,EAAEJ,OAAO,CAACK,sBAAsB,CAAC,CAAC;YAC9DC,mBAAmB,EAAE;gBAAC,OAAO;aAAC;SAC/B,CAAC,CAAC;QACH,kFAAkF;QAClF,OAAO;IACT,CAAC;IAED,IAAIpB,YAAY,CAACD,MAAM,EAAE;QACvB,MAAMsB,iBAAiB,GAAGrB,YAAY,CAACsB,GAAG,CACxC,CAACnB,GAAG,GAAK,CAAC,EAAEA,GAAG,CAACa,WAAW,CAAC,CAAC,EAAEb,GAAG,CAACgB,sBAAsB,CAAC,CAAC,CAC5D,AAAC;QAEF,MAAMvB,cAAc,CAAC2B,QAAQ,CAAC;eAAIzB,uBAAuB;eAAKuB,iBAAiB;SAAC,CAAC,CAAC;QAElF,MAAMG,IAAAA,aAAiB,kBAAA,EAAC9B,WAAW,EAAE2B,iBAAiB,CAAC,CAAC;IAC1D,CAAC;IAED,IAAIpB,eAAe,CAACF,MAAM,EAAE;QAC1B,MAAMH,cAAc,CAAC6B,WAAW,CAAC;eAC5B3B,uBAAuB;eACvBG,eAAe,CAACqB,GAAG,CAAC,CAACnB,GAAG,GAAK,CAAC,EAAEA,GAAG,CAACa,WAAW,CAAC,CAAC,EAAEb,GAAG,CAACgB,sBAAsB,CAAC,CAAC,CAAC;SACpF,CAAC,CAAC;IACL,CAAC;AACH,CAAC"}