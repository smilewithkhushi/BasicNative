{"version":3,"sources":["../../../src/export/favicon.ts"],"sourcesContent":["import { ExpoConfig, getConfig } from '@expo/config';\nimport { generateFaviconAsync, generateImageAsync } from '@expo/image-utils';\nimport fs from 'fs';\nimport path from 'path';\n\nimport { getUserDefinedFile } from './publicFolder';\nimport { ExportAssetMap } from './saveAssets';\nimport { Log } from '../log';\n\nconst debug = require('debug')('expo:favicon') as typeof console.log;\n\n/** @returns the file system path for a user-defined favicon.ico file in the public folder. */\nexport function getUserDefinedFaviconFile(projectRoot: string): string | null {\n  return getUserDefinedFile(projectRoot, ['./favicon.ico']);\n}\n\nexport async function getVirtualFaviconAssetsAsync(\n  projectRoot: string,\n  {\n    baseUrl,\n    outputDir,\n    files,\n    exp,\n  }: { outputDir: string; baseUrl: string; files?: ExportAssetMap; exp?: ExpoConfig }\n): Promise<((html: string) => string) | null> {\n  const existing = getUserDefinedFaviconFile(projectRoot);\n  if (existing) {\n    debug('Using user-defined favicon.ico file.');\n    return null;\n  }\n\n  const data = await getFaviconFromExpoConfigAsync(projectRoot, {\n    exp,\n  });\n\n  if (!data) {\n    return null;\n  }\n\n  await Promise.all(\n    [data].map(async (asset) => {\n      const assetPath = path.join(outputDir, asset.path);\n      if (files) {\n        debug('Storing asset for persisting: ' + assetPath);\n        files?.set(asset.path, {\n          contents: asset.source,\n          targetDomain: 'client',\n        });\n      } else {\n        debug('Writing asset to disk: ' + assetPath);\n        await fs.promises.writeFile(assetPath, asset.source);\n      }\n    })\n  );\n\n  function injectFaviconTag(html: string): string {\n    if (!html.includes('</head>')) {\n      return html;\n    }\n    return html.replace(\n      '</head>',\n      `<link rel=\"shortcut icon\" href=\"${baseUrl}/favicon.ico\" /></head>`\n    );\n  }\n\n  return injectFaviconTag;\n}\n\nexport async function getFaviconFromExpoConfigAsync(\n  projectRoot: string,\n  { force = false, exp = getConfig(projectRoot).exp }: { force?: boolean; exp?: ExpoConfig } = {}\n) {\n  const src = exp.web?.favicon ?? null;\n  if (!src) {\n    return null;\n  }\n\n  const dims = [16, 32, 48];\n  const cacheType = 'favicon';\n\n  const size = dims[dims.length - 1];\n  try {\n    const { source } = await generateImageAsync(\n      { projectRoot, cacheType },\n      {\n        resizeMode: 'contain',\n        src,\n        backgroundColor: 'transparent',\n        width: size,\n        height: size,\n        name: `favicon-${size}.png`,\n      }\n    );\n\n    const faviconBuffer = await generateFaviconAsync(source, dims);\n\n    return { source: faviconBuffer, path: 'favicon.ico' };\n  } catch (error: any) {\n    // Check for ENOENT\n    if (!force && error.code === 'ENOENT') {\n      Log.warn(`Favicon source file in Expo config (web.favicon) does not exist: ${src}`);\n      return null;\n    }\n    throw error;\n  }\n}\n"],"names":["getUserDefinedFaviconFile","getVirtualFaviconAssetsAsync","getFaviconFromExpoConfigAsync","debug","require","projectRoot","getUserDefinedFile","baseUrl","outputDir","files","exp","existing","data","Promise","all","map","asset","assetPath","path","join","set","contents","source","targetDomain","fs","promises","writeFile","injectFaviconTag","html","includes","replace","force","getConfig","src","web","favicon","dims","cacheType","size","length","generateImageAsync","resizeMode","backgroundColor","width","height","name","faviconBuffer","generateFaviconAsync","error","code","Log","warn"],"mappings":"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"}