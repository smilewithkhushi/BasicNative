{"version":3,"sources":["../../../../../src/run/ios/codeSigning/configureCodeSigning.ts"],"sourcesContent":["import chalk from 'chalk';\n\nimport * as Security from './Security';\nimport { resolveCertificateSigningIdentityAsync } from './resolveCertificateSigningIdentity';\nimport { getCodeSigningInfoForPbxproj, setAutoCodeSigningInfoForPbxproj } from './xcodeCodeSigning';\nimport * as Log from '../../../log';\n\nexport async function ensureDeviceIsCodeSignedForDeploymentAsync(\n  projectRoot: string\n): Promise<string | null> {\n  if (isCodeSigningConfigured(projectRoot)) {\n    return null;\n  }\n  return configureCodeSigningAsync(projectRoot);\n}\n\nfunction isCodeSigningConfigured(projectRoot: string): boolean {\n  // Check if the app already has a development team defined.\n  const signingInfo = getCodeSigningInfoForPbxproj(projectRoot);\n\n  const allTargetsHaveTeams = Object.values(signingInfo).reduce((prev, curr) => {\n    return prev && !!curr.developmentTeams.length;\n  }, true);\n\n  if (allTargetsHaveTeams) {\n    const teamList = Object.values(signingInfo).reduce<string[]>((prev, curr) => {\n      return prev.concat([curr.developmentTeams[0]]);\n    }, []);\n    Log.log(chalk.dim`\\u203A Auto signing app using team(s): ${teamList.join(', ')}`);\n    return true;\n  }\n\n  const allTargetsHaveProfiles = Object.values(signingInfo).reduce((prev, curr) => {\n    return prev && !!curr.provisioningProfiles.length;\n  }, true);\n\n  if (allTargetsHaveProfiles) {\n    // this indicates that the user has manual code signing setup (possibly for production).\n    return true;\n  }\n  return false;\n}\n\nasync function configureCodeSigningAsync(projectRoot: string) {\n  const ids = await Security.findIdentitiesAsync();\n\n  const id = await resolveCertificateSigningIdentityAsync(ids);\n\n  Log.log(`\\u203A Signing and building iOS app with: ${id.codeSigningInfo}`);\n\n  setAutoCodeSigningInfoForPbxproj(projectRoot, {\n    appleTeamId: id.appleTeamId!,\n  });\n  return id.appleTeamId!;\n}\n"],"names":["ensureDeviceIsCodeSignedForDeploymentAsync","projectRoot","isCodeSigningConfigured","configureCodeSigningAsync","signingInfo","getCodeSigningInfoForPbxproj","allTargetsHaveTeams","Object","values","reduce","prev","curr","developmentTeams","length","teamList","concat","Log","log","chalk","dim","join","allTargetsHaveProfiles","provisioningProfiles","ids","Security","findIdentitiesAsync","id","resolveCertificateSigningIdentityAsync","codeSigningInfo","setAutoCodeSigningInfoForPbxproj","appleTeamId"],"mappings":"AAAA;;;;+BAOsBA,4CAA0C;;aAA1CA,0CAA0C;;;8DAP9C,OAAO;;;;;;gEAEC,YAAY;mDACiB,qCAAqC;kCACb,oBAAoB;2DAC9E,cAAc;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE5B,eAAeA,0CAA0C,CAC9DC,WAAmB,EACK;IACxB,IAAIC,uBAAuB,CAACD,WAAW,CAAC,EAAE;QACxC,OAAO,IAAI,CAAC;IACd,CAAC;IACD,OAAOE,yBAAyB,CAACF,WAAW,CAAC,CAAC;AAChD,CAAC;AAED,SAASC,uBAAuB,CAACD,WAAmB,EAAW;IAC7D,2DAA2D;IAC3D,MAAMG,WAAW,GAAGC,IAAAA,iBAA4B,6BAAA,EAACJ,WAAW,CAAC,AAAC;IAE9D,MAAMK,mBAAmB,GAAGC,MAAM,CAACC,MAAM,CAACJ,WAAW,CAAC,CAACK,MAAM,CAAC,CAACC,IAAI,EAAEC,IAAI,GAAK;QAC5E,OAAOD,IAAI,IAAI,CAAC,CAACC,IAAI,CAACC,gBAAgB,CAACC,MAAM,CAAC;IAChD,CAAC,EAAE,IAAI,CAAC,AAAC;IAET,IAAIP,mBAAmB,EAAE;QACvB,MAAMQ,QAAQ,GAAGP,MAAM,CAACC,MAAM,CAACJ,WAAW,CAAC,CAACK,MAAM,CAAW,CAACC,IAAI,EAAEC,IAAI,GAAK;YAC3E,OAAOD,IAAI,CAACK,MAAM,CAAC;gBAACJ,IAAI,CAACC,gBAAgB,CAAC,CAAC,CAAC;aAAC,CAAC,CAAC;QACjD,CAAC,EAAE,EAAE,CAAC,AAAC;QACPI,IAAG,CAACC,GAAG,CAACC,MAAK,EAAA,QAAA,CAACC,GAAG,CAAC,uCAAuC,EAAEL,QAAQ,CAACM,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC;QAClF,OAAO,IAAI,CAAC;IACd,CAAC;IAED,MAAMC,sBAAsB,GAAGd,MAAM,CAACC,MAAM,CAACJ,WAAW,CAAC,CAACK,MAAM,CAAC,CAACC,IAAI,EAAEC,IAAI,GAAK;QAC/E,OAAOD,IAAI,IAAI,CAAC,CAACC,IAAI,CAACW,oBAAoB,CAACT,MAAM,CAAC;IACpD,CAAC,EAAE,IAAI,CAAC,AAAC;IAET,IAAIQ,sBAAsB,EAAE;QAC1B,wFAAwF;QACxF,OAAO,IAAI,CAAC;IACd,CAAC;IACD,OAAO,KAAK,CAAC;AACf,CAAC;AAED,eAAelB,yBAAyB,CAACF,WAAmB,EAAE;IAC5D,MAAMsB,GAAG,GAAG,MAAMC,SAAQ,CAACC,mBAAmB,EAAE,AAAC;IAEjD,MAAMC,EAAE,GAAG,MAAMC,IAAAA,kCAAsC,uCAAA,EAACJ,GAAG,CAAC,AAAC;IAE7DP,IAAG,CAACC,GAAG,CAAC,CAAC,0CAA0C,EAAES,EAAE,CAACE,eAAe,CAAC,CAAC,CAAC,CAAC;IAE3EC,IAAAA,iBAAgC,iCAAA,EAAC5B,WAAW,EAAE;QAC5C6B,WAAW,EAAEJ,EAAE,CAACI,WAAW;KAC5B,CAAC,CAAC;IACH,OAAOJ,EAAE,CAACI,WAAW,CAAE;AACzB,CAAC"}