{"version":3,"sources":["../../../../src/export/embed/exportEmbedAsync.ts"],"sourcesContent":["/**\n * Copyright Â© 2023 650 Industries.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\nimport { getConfig } from '@expo/config';\nimport getMetroAssets from '@expo/metro-config/build/transform-worker/getAssets';\nimport assert from 'assert';\nimport fs from 'fs';\nimport { sync as globSync } from 'glob';\nimport Server from 'metro/src/Server';\nimport splitBundleOptions from 'metro/src/lib/splitBundleOptions';\nimport output from 'metro/src/shared/output/bundle';\nimport type { BundleOptions } from 'metro/src/shared/types';\nimport path from 'path';\n\nimport { Options } from './resolveOptions';\nimport { isExecutingFromXcodebuild, logMetroErrorInXcode } from './xcodeCompilerLogger';\nimport { Log } from '../../log';\nimport { DevServerManager } from '../../start/server/DevServerManager';\nimport { MetroBundlerDevServer } from '../../start/server/metro/MetroBundlerDevServer';\nimport { loadMetroConfigAsync } from '../../start/server/metro/instantiateMetro';\nimport { assertMetroPrivateServer } from '../../start/server/metro/metroPrivateServer';\nimport { getMetroDirectBundleOptionsForExpoConfig } from '../../start/server/middleware/metroOptions';\nimport { stripAnsi } from '../../utils/ansi';\nimport { removeAsync } from '../../utils/dir';\nimport { setNodeEnv } from '../../utils/nodeEnv';\nimport { isEnableHermesManaged } from '../exportHermes';\nimport { persistMetroAssetsAsync } from '../persistMetroAssets';\nimport { BundleAssetWithFileHashes } from '../saveAssets';\n\nconst debug = require('debug')('expo:export:embed');\n\nfunction guessCopiedAppleBundlePath(bundleOutput: string) {\n  // Ensure the path is familiar before guessing.\n  if (!bundleOutput.match(/\\/Xcode\\/DerivedData\\/.*\\/Build\\/Products\\//)) {\n    debug('Bundling to non-standard location:', bundleOutput);\n    return false;\n  }\n  const bundleName = path.basename(bundleOutput);\n  const bundleParent = path.dirname(bundleOutput);\n  const possiblePath = globSync(path.join(bundleParent, `*.app/${bundleName}`), {\n    // bundle identifiers can start with dots.\n    dot: true,\n  })[0];\n  debug('Possible path for previous bundle:', possiblePath);\n  return possiblePath;\n}\n\nexport async function exportEmbedAsync(projectRoot: string, options: Options) {\n  setNodeEnv(options.dev ? 'development' : 'production');\n  require('@expo/env').load(projectRoot);\n\n  // Ensure we delete the old bundle to trigger a failure if the bundle cannot be created.\n  await removeAsync(options.bundleOutput);\n\n  // The iOS bundle is copied in to the Xcode project, so we need to remove the old one\n  // to prevent Xcode from loading the old one after a build failure.\n  if (options.platform === 'ios') {\n    const previousPath = guessCopiedAppleBundlePath(options.bundleOutput);\n    if (previousPath && fs.existsSync(previousPath)) {\n      debug('Removing previous iOS bundle:', previousPath);\n      await removeAsync(previousPath);\n    }\n  }\n\n  const { bundle, assets } = await exportEmbedBundleAndAssetsAsync(projectRoot, options);\n\n  fs.mkdirSync(path.dirname(options.bundleOutput), { recursive: true, mode: 0o755 });\n\n  // Persist bundle and source maps.\n  await Promise.all([\n    output.save(bundle, options, Log.log),\n    // NOTE(EvanBacon): This may need to be adjusted in the future if want to support baseUrl on native\n    // platforms when doing production embeds (unlikely).\n    options.assetsDest\n      ? persistMetroAssetsAsync(assets, {\n          platform: options.platform,\n          outputDirectory: options.assetsDest,\n          iosAssetCatalogDirectory: options.assetCatalogDest,\n        })\n      : null,\n  ]);\n}\n\nexport async function exportEmbedBundleAndAssetsAsync(\n  projectRoot: string,\n  options: Options\n): Promise<{\n  bundle: Awaited<ReturnType<Server['build']>>;\n  assets: readonly BundleAssetWithFileHashes[];\n}> {\n  const devServerManager = await DevServerManager.startMetroAsync(projectRoot, {\n    minify: options.minify,\n    mode: options.dev ? 'development' : 'production',\n    port: 8081,\n    isExporting: true,\n    location: {},\n    resetDevServer: options.resetCache,\n    maxWorkers: options.maxWorkers,\n  });\n\n  const devServer = devServerManager.getDefaultDevServer();\n  assert(devServer instanceof MetroBundlerDevServer);\n\n  const exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp;\n  const isHermes = isEnableHermesManaged(exp, options.platform);\n\n  let sourceMapUrl = options.sourcemapOutput;\n  if (sourceMapUrl && !options.sourcemapUseAbsolutePath) {\n    sourceMapUrl = path.basename(sourceMapUrl);\n  }\n\n  try {\n    const bundles = await devServer.legacySinglePageExportBundleAsync(\n      {\n        splitChunks: false,\n        mainModuleName: resolveRealEntryFilePath(projectRoot, options.entryFile),\n        platform: options.platform,\n        minify: options.minify,\n        mode: options.dev ? 'development' : 'production',\n        engine: isHermes ? 'hermes' : undefined,\n        serializerIncludeMaps: !!sourceMapUrl,\n        // Never output bytecode in the exported bundle since that is hardcoded in the native run script.\n        bytecode: false,\n        // source map inline\n        reactCompiler: !!exp.experiments?.reactCompiler,\n      },\n      {\n        sourceMapUrl,\n        unstable_transformProfile: (options.unstableTransformProfile ||\n          (isHermes ? 'hermes-stable' : 'default')) as BundleOptions['unstable_transformProfile'],\n      }\n    );\n\n    return {\n      bundle: {\n        code: bundles.artifacts.filter((a: any) => a.type === 'js')[0].source.toString(),\n        // Can be optional when source maps aren't enabled.\n        map: bundles.artifacts.filter((a: any) => a.type === 'map')[0]?.source.toString(),\n      },\n      assets: bundles.assets,\n    };\n  } catch (error: any) {\n    if (isError(error)) {\n      // Log using Xcode error format so the errors are picked up by xcodebuild.\n      // https://developer.apple.com/documentation/xcode/running-custom-scripts-during-a-build#Log-errors-and-warnings-from-your-script\n      if (options.platform === 'ios') {\n        // If the error is about to be presented in Xcode, strip the ansi characters from the message.\n        if ('message' in error && isExecutingFromXcodebuild()) {\n          error.message = stripAnsi(error.message) as string;\n        }\n        logMetroErrorInXcode(projectRoot, error);\n      }\n    }\n    throw error;\n  } finally {\n    devServerManager.stopAsync();\n  }\n}\n\n// Exports for expo-updates\nexport async function createMetroServerAndBundleRequestAsync(\n  projectRoot: string,\n  options: Pick<\n    Options,\n    | 'maxWorkers'\n    | 'config'\n    | 'platform'\n    | 'sourcemapOutput'\n    | 'sourcemapUseAbsolutePath'\n    | 'entryFile'\n    | 'minify'\n    | 'dev'\n    | 'resetCache'\n    | 'unstableTransformProfile'\n  >\n): Promise<{ server: Server; bundleRequest: BundleOptions }> {\n  const exp = getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp;\n\n  // TODO: This is slow ~40ms\n  const { config } = await loadMetroConfigAsync(\n    projectRoot,\n    {\n      // TODO: This is always enabled in the native script and there's no way to disable it.\n      resetCache: options.resetCache,\n\n      maxWorkers: options.maxWorkers,\n      config: options.config,\n    },\n    {\n      exp,\n      isExporting: true,\n      getMetroBundler() {\n        return server.getBundler().getBundler();\n      },\n    }\n  );\n\n  const isHermes = isEnableHermesManaged(exp, options.platform);\n\n  let sourceMapUrl = options.sourcemapOutput;\n  if (sourceMapUrl && !options.sourcemapUseAbsolutePath) {\n    sourceMapUrl = path.basename(sourceMapUrl);\n  }\n\n  const bundleRequest = {\n    ...Server.DEFAULT_BUNDLE_OPTIONS,\n    ...getMetroDirectBundleOptionsForExpoConfig(projectRoot, exp, {\n      splitChunks: false,\n      mainModuleName: resolveRealEntryFilePath(projectRoot, options.entryFile),\n      platform: options.platform,\n      minify: options.minify,\n      mode: options.dev ? 'development' : 'production',\n      engine: isHermes ? 'hermes' : undefined,\n      isExporting: true,\n      // Never output bytecode in the exported bundle since that is hardcoded in the native run script.\n      bytecode: false,\n    }),\n    sourceMapUrl,\n    unstable_transformProfile: (options.unstableTransformProfile ||\n      (isHermes ? 'hermes-stable' : 'default')) as BundleOptions['unstable_transformProfile'],\n  };\n\n  const server = new Server(config, {\n    watch: false,\n  });\n\n  return { server, bundleRequest };\n}\n\nexport async function exportEmbedAssetsAsync(\n  server: Server,\n  bundleRequest: BundleOptions,\n  projectRoot: string,\n  options: Pick<Options, 'platform'>\n) {\n  try {\n    const { entryFile, onProgress, resolverOptions, transformOptions } = splitBundleOptions({\n      ...bundleRequest,\n      bundleType: 'todo',\n    });\n\n    assertMetroPrivateServer(server);\n\n    const dependencies = await server._bundler.getDependencies(\n      [entryFile],\n      transformOptions,\n      resolverOptions,\n      { onProgress, shallow: false, lazy: false }\n    );\n\n    const config = server._config;\n\n    return getMetroAssets(dependencies, {\n      processModuleFilter: config.serializer.processModuleFilter,\n      assetPlugins: config.transformer.assetPlugins,\n      platform: transformOptions.platform!,\n      // Forked out of Metro because the `this._getServerRootDir()` doesn't match the development\n      // behavior.\n      projectRoot: config.projectRoot, // this._getServerRootDir(),\n      publicPath: config.transformer.publicPath,\n    });\n  } catch (error: any) {\n    if (isError(error)) {\n      // Log using Xcode error format so the errors are picked up by xcodebuild.\n      // https://developer.apple.com/documentation/xcode/running-custom-scripts-during-a-build#Log-errors-and-warnings-from-your-script\n      if (options.platform === 'ios') {\n        // If the error is about to be presented in Xcode, strip the ansi characters from the message.\n        if ('message' in error && isExecutingFromXcodebuild()) {\n          error.message = stripAnsi(error.message) as string;\n        }\n        logMetroErrorInXcode(projectRoot, error);\n      }\n    }\n    throw error;\n  }\n}\n\nfunction isError(error: any): error is Error {\n  return error instanceof Error;\n}\n\n/**\n * This is a workaround for Metro not resolving entry file paths to their real location.\n * When running exports through `eas build --local` on macOS, the `/var/folders` path is used instead of `/private/var/folders`.\n *\n * See: https://github.com/expo/expo/issues/28890\n */\nfunction resolveRealEntryFilePath(projectRoot: string, entryFile: string): string {\n  if (projectRoot.startsWith('/private/var') && entryFile.startsWith('/var')) {\n    return fs.realpathSync(entryFile);\n  }\n\n  return entryFile;\n}\n"],"names":["exportEmbedAsync","exportEmbedBundleAndAssetsAsync","createMetroServerAndBundleRequestAsync","exportEmbedAssetsAsync","debug","require","guessCopiedAppleBundlePath","bundleOutput","match","bundleName","path","basename","bundleParent","dirname","possiblePath","globSync","join","dot","projectRoot","options","setNodeEnv","dev","load","removeAsync","platform","previousPath","fs","existsSync","bundle","assets","mkdirSync","recursive","mode","Promise","all","output","save","Log","log","assetsDest","persistMetroAssetsAsync","outputDirectory","iosAssetCatalogDirectory","assetCatalogDest","devServerManager","DevServerManager","startMetroAsync","minify","port","isExporting","location","resetDevServer","resetCache","maxWorkers","devServer","getDefaultDevServer","assert","MetroBundlerDevServer","exp","getConfig","skipSDKVersionRequirement","isHermes","isEnableHermesManaged","sourceMapUrl","sourcemapOutput","sourcemapUseAbsolutePath","bundles","legacySinglePageExportBundleAsync","splitChunks","mainModuleName","resolveRealEntryFilePath","entryFile","engine","undefined","serializerIncludeMaps","bytecode","reactCompiler","experiments","unstable_transformProfile","unstableTransformProfile","code","artifacts","filter","a","type","source","toString","map","error","isError","isExecutingFromXcodebuild","message","stripAnsi","logMetroErrorInXcode","stopAsync","config","loadMetroConfigAsync","getMetroBundler","server","getBundler","bundleRequest","Server","DEFAULT_BUNDLE_OPTIONS","getMetroDirectBundleOptionsForExpoConfig","watch","onProgress","resolverOptions","transformOptions","splitBundleOptions","bundleType","assertMetroPrivateServer","dependencies","_bundler","getDependencies","shallow","lazy","_config","getMetroAssets","processModuleFilter","serializer","assetPlugins","transformer","publicPath","Error","startsWith","realpathSync"],"mappings":"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"}